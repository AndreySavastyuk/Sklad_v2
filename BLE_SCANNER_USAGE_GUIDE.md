# Руководство по использованию BLE сканера (Обновленное)

## Обзор изменений

Полностью переработана система сопряжения BLE сканера:
- ✅ **Упрощено до одной кнопки** - больше никаких сложных диалогов
- ✅ **Автоматическое распознавание данных** - сканированные данные автоматически попадают в приемку
- ✅ **Исправлено дублирование observer** - больше никаких ошибок регистрации
- ✅ **Убраны лишние экраны** - все управление в настройках
- ✅ **Рабочая кнопка тестирования** - проверка подключения сканера

## Как использовать

### 1. Подключение сканера

1. Откройте **Настройки** из главного меню
2. В разделе "BLE Сканер" нажмите **"Подключить сканер"**
3. QR-код появится автоматически
4. Отсканируйте QR-код вашим Newland сканером
5. Сканер подключится автоматически без дополнительных диалогов

### 2. Использование в приемке

1. Перейдите в раздел **"Приемка"**
2. Если сканер подключен, вы увидите "BLE сканер подключен"
3. Просто сканируйте QR-код - данные автоматически появятся в поле
4. Заполните количество и ячейку
5. Нажмите **"Печать этикетки"**

### 3. Тестирование

В настройках при подключенном сканере:
- Нажмите **"Тест"** для проверки связи
- Нажмите **"Отключить"** для отключения сканера

## Технические детали

### Исправленные проблемы:

1. **Дублирование Observer**: Добавлен флаг `isObserverRegistered` в `BleScannerManager`
2. **Старое состояние в приемке**: AcceptViewModel теперь использует реальное состояние BLE
3. **Передача данных**: Упрощен механизм через `BleScannerIntegration` компонент
4. **Множественные экраны**: Удален отдельный экран сопряжения
5. **Кнопка тестирования**: Добавлен метод `testConnection()` в `BleScannerManager`

### Архитектура

```
BleScannerManager (Singleton)
    ├── connectScanner() - одна кнопка для всего
    ├── disconnectScanner() - отключение
    ├── testConnection() - тестирование
    └── scanResult Flow - автоматическая передача данных

SettingsScreen
    └── Простая кнопка + QR код + тест

AcceptScreen
    └── BleScannerIntegration - автоматически получает данные
```

### Состояния BLE подключения

- `DISCONNECTED` - Не подключен
- `GENERATING_QR` - Генерация QR-кода (показывается спиннер)  
- `WAITING_FOR_SCAN` - Ожидание сканирования QR-кода
- `CONNECTED` - Подключен и готов к работе
- `ERROR` - Ошибка подключения

## Логи для отладки

При подключении в логах должно быть:
```
BleScannerManager: Начинаем подключение к BLE сканеру...
BleScannerManager: QR-код создан и режим сопряжения запущен
BleScannerManager: Сканер подключён: E2:34:0A:DC:75:EF
BleScannerManager: Получены данные сканирования (UTF-8): [данные]
```

При ошибках:
```
BleScannerManager: Ошибка подключения сканера: [причина]
```

## Что исправлено из логов

1. **Observer already registered** - исправлено флагом регистрации
2. **Данные не передаются** - исправлено упрощением BleScannerIntegration
3. **Сканер показывается как недоступен** - исправлено синхронизацией состояния
4. **Кнопка тестирования** - добавлена рабочая реализация
5. **Повторное нажатие отключает** - исправлено проверкой состояния

Теперь система работает просто и надежно: одна кнопка подключения, автоматический QR, прямая передача данных в приемку. 