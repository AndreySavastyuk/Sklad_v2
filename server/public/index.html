<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Складские задания</title>
  <script type="module" src="https://cdn.jsdelivr.net/npm/@fluentui/web-components@2"></script>
  <style>
    body{font-family:'Segoe UI',Tahoma,sans-serif;margin:20px;background:#f5f6f7;}
    .container{max-width:1000px;margin:auto;}
    table{width:100%;border-collapse:collapse;margin-top:16px;}
    th,td{border:1px solid #ccc;padding:6px;}
    th{background:#f3f2f1;text-align:left;}
    .drop-area{border:2px dashed #888;padding:20px;text-align:center;margin-top:10px;cursor:pointer;}
    .drop-area.dragover{background:#dfe9f6;}
  </style>
</head>
<body>
<div class="container">
  <h1>Система заданий</h1>
  <fluent-button appearance="accent" id="newTaskBtn">Новая задача</fluent-button>
  <div style="margin-top:20px">
    <table id="tasksTable">
      <thead>
        <tr><th>ID</th><th>Номер</th><th>Статус</th><th>Комментарий</th><th>Сборок</th><th></th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  <section id="itemEditor" style="display:none;margin-top:30px;">
    <h3>Позиции</h3>
    <div style="margin-bottom:8px;">
      <fluent-button id="addRowBtn">Добавить позицию</fluent-button>
    </div>
    <table id="itemsTable">
      <thead></thead>
      <tbody></tbody>
    </table>
  </section>
</div>

<fluent-dialog id="taskDialog">
  <span slot="title">Новая заявка</span>
  <div slot="content">
    <fluent-text-field id="orderInput" placeholder="Заказ" style="width:100%;"></fluent-text-field>
    <fluent-select id="priorityInput" style="width:100%;margin-top:8px;">
      <fluent-option value="normal">Обычный</fluent-option>
      <fluent-option value="urgent">Срочный</fluent-option>
    </fluent-select>
    <div class="drop-area" id="dropArea">Перетащите Excel файл сюда</div>
  </div>
  <fluent-button slot="footer" appearance="accent" id="dialogOk">OK</fluent-button>
  <fluent-button slot="footer" appearance="stealth" id="dialogCancel">Отмена</fluent-button>
</fluent-dialog>

<script>
async function api(method, url, body){
  const opts = {method, headers:{'Content-Type':'application/json'}};
  if(body) opts.body = JSON.stringify(body);
  const res = await fetch(url, opts);
  if(res.ok) return res.json();
  throw new Error(await res.text());
}
async function loadTasks(){
  const data = await api('GET','/tasks');
  const tbody = document.querySelector('#tasksTable tbody');
  tbody.innerHTML='';
  data.forEach(t=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${t.id}</td>
      <td>${t.task_number}</td>
      <td><fluent-select class="status" data-id="${t.id}">
        <fluent-option value="created" ${t.status==='created'?'selected':''}>Создано</fluent-option>
        <fluent-option value="sent" ${t.status==='sent'?'selected':''}>Отправлено</fluent-option>
        <fluent-option value="in_progress" ${t.status==='in_progress'?'selected':''}>В работе</fluent-option>
        <fluent-option value="completed" ${t.status==='completed'?'selected':''}>Выполнено</fluent-option>
      </fluent-select></td>
      <td><fluent-text-field class="comment" data-id="${t.id}" value="${t.comment||''}"></fluent-text-field></td>
      <td><fluent-text-field type="number" class="count" data-id="${t.id}" value="${t.assembly_count}" style="width:80px;"></fluent-text-field></td>
      <td><fluent-button appearance="accent" class="save" data-id="${t.id}">Сохранить</fluent-button></td>`;
    tbody.appendChild(tr);
  });
}

document.addEventListener('click', async e=>{
  if(e.target.classList.contains('save')){
    const id=e.target.dataset.id;
    const row=e.target.closest('tr');
    const comment=row.querySelector('.comment').value;
    const assembly=parseInt(row.querySelector('.count').value);
    const status=row.querySelector('.status').value;
    try{await api('PUT',`/tasks/${id}`,{comment,assembly_count:assembly,status});
      loadTasks();
    }catch(err){alert(err.message);}
  }
});

document.getElementById('newTaskBtn').addEventListener('click',()=>{
  document.getElementById('orderInput').value='';
  document.getElementById('priorityInput').value='normal';
  dropArea.classList.remove('dragover');
  droppedFile=null;
  taskDialog.show();
});

const dropArea=document.getElementById('dropArea');
const taskDialog=document.getElementById('taskDialog');
let droppedFile=null;
['dragover','dragenter'].forEach(ev=>dropArea.addEventListener(ev,e=>{e.preventDefault();dropArea.classList.add('dragover');}));
['dragleave','drop'].forEach(ev=>dropArea.addEventListener(ev,e=>{e.preventDefault();dropArea.classList.remove('dragover');}));
dropArea.addEventListener('drop',e=>{droppedFile=e.dataTransfer.files[0];});

document.getElementById('dialogCancel').addEventListener('click',()=>taskDialog.hide());

document.getElementById('dialogOk').addEventListener('click',async()=>{
  if(!droppedFile) return;
  const fd=new FormData();
  fd.append('file',droppedFile);
  const res=await fetch('/tasks/parse',{method:'POST',body:fd});
  if(res.ok){
    const data=await res.json();
    renderItemsTable(data.headers,data.items);
    taskDialog.hide();
  }else{alert('Ошибка при парсинге файла');}
});

function renderItemsTable(headers,items){
  const thead=document.querySelector('#itemsTable thead');
  const tbody=document.querySelector('#itemsTable tbody');
  thead.innerHTML='<tr>'+headers.map(h=>`<th>${h}</th><th></th>`).join('')+'</tr>';
  tbody.innerHTML='';
  items.forEach(item=>addRow(headers,item));
  document.getElementById('itemEditor').style.display='block';
}
function addRow(headers,values={}){
  const tbody=document.querySelector('#itemsTable tbody');
  const tr=document.createElement('tr');
  tr.innerHTML=headers.map(h=>`<td><fluent-text-field value="${values[h]||''}"></fluent-text-field></td>`).join('')+
    '<td><fluent-button appearance="stealth" class="del">✕</fluent-button></td>';
  tbody.appendChild(tr);
}

document.getElementById('addRowBtn').addEventListener('click',()=>{
  const headers=Array.from(document.querySelectorAll('#itemsTable thead th')).map(th=>th.textContent).filter(t=>t);
  addRow(headers,{});
});

document.querySelector('#itemsTable').addEventListener('click',e=>{
  if(e.target.classList.contains('del')){
    e.target.closest('tr').remove();
  }
});

loadTasks();
</script>
</body>
</html>
